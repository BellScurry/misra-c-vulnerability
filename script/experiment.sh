# Usage
#   $1: Config File
#       ex) config1.csv
read_csvconfig() {

    if [[ "$#" -ne 1 ]]; then
        exit
    fi

    result=""
    while IFS= read -r line || [[ -n $line ]];
    do
        col1=$(echo $line | sed 's/\(.*\),.*/\1/')

        if [[ ! -z $(echo $line | awk '/[^,]*,\s*\S+.*/') ]]; then

            col2=$(echo $line | sed 's/^[^,]*,[[:space:]]*\(.*\)$/\1/')
            result="$result --$col1=$col2 "
        else
            result="$result --$col1 "
        fi
    done < $1

    echo $result
}

# Usage
#   $1: 'gemV' Binary
#   $2: Config File
#   $3: Benchmark
#   $4: Benchmark Input
single_experiment() {

    $1 $2 -c $3 -o $4
}

# Usage
#   $1: 'gemV' Home
#   $2: Benchmark Path
#   $3: Benchmark Input Path
#   $4: Config File Directory
#
WHERE_AM_I=$(pwd)/$(dirname "$0")

if [ "$#" -gt 0 ]; then
    GEMV_HOME=$1
else
    GEMV_HOME=$(cat $WHERE_AM_I/config/gemv_home)
fi
 
if [ "$#" -gt 1 ]; then
    BENCHMARK_HOME=$2
else
    BENCHMARK_HOME=$(cat $WHERE_AM_I/config/benchmark_home)
fi

if [ "$#" -gt 3 ]; then
    CONFIG_FILE_DIR=$4
else
    CONFIG_FILE_DIR=$WHERE_AM_I/config
fi

# Rel Path Info
GEMV_SIMSCRIPT="$GEMV_HOME/configs/example/se.py" #Pathtoconfigfile

# Config List
arch_list=("ARM")
misrac_tf=("" "_misrac")
susan_option=("" "-e" "-c")
susan_option_desc=("smoothing" "edge" "corner")

# Benchmark Input
input_file_name="input_large"
input_file_extension=".pgm"

for file in $CONFIG_FILE_DIR/*
do
    filename=$(echo $file | sed 's/\(.*\/\)*\([^.]*\)[.]*.*/\2/')

    if [[ ! -z $(echo $filename | awk '/config[0-9]+/') ]]; then
        confignum=$(echo $filename | sed 's/config\([0-9]\+\).*/\1/')
        config=$(read_csvconfig $file)
    fi
done

for arch in "${arch_list[@]}";
do
    gemv_binary="$GEMV_HOME/build/$arch/gem5.opt"

    for misrac in "${misrac_tf[@]}";
    do
        benchmark="$BENCHMARK_HOME/susan${misrac}_$arch"

        for (( i=0 ; i < 3 ; i++));
        do
            output_dir="$GEMV_HOME/output/susan${misrac}_${susan_option_desc[$i]}_${arch}/benchinput_${input_file_name}"
            benchmark_input="$BENCHMARK_HOME/$input_file_name$input_file_extension${susan_option[$i]}"
            $gemv_binary -re -d $output_dir $GEMV_SIMSCRIPT $config --cmd=${benchmark} --options=${benchmark_input} --vul_params="$GEMV_HOME/params.in"
        done
    done
done
