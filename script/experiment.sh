usage() {

    echo "Usage: experiment.sh [--help] <--gemv-home=path>"
    echo "                     <--sim-list=path> <--config-dir=path>"
}

# Usage
#   $1: Config File
#       ex) config1.csv
read_csvconfig() {

    if [[ "$#" -ne 1 ]]; then
        exit
    fi

    result=""
    while IFS= read -r line || [[ -n $line ]];
    do
        col1=$(echo $line | sed 's/\(.*\),.*/\1/')

        if [[ ! -z $(echo $line | awk '/[^,]*,\s*\S+.*/') ]]; then

            col2=$(echo $line | sed 's/^[^,]*,[[:space:]]*\(.*\)$/\1/')
            result="$result --$col1=$col2 "
        else
            result="$result --$col1 "
        fi
    done < $1

    echo $result
}

# Usage
#    $1: Stat File
#    $2: Output File
stat2csv() {

    if [[ "$#" -ne 2 ]]; then
        exit
    fi

    sed $1 > $2 \
        -e '/^.*\(Begin\|End\).*$/d' \
        -e '/^[[:space:]]*$/d' \
        -e 's/#.*$//' \
        -e 's/[[:space:]]\+\([^[:space:]]\+\)/, \1/g'
}

# Usage
#    $1: Statistics File
#    $2: Digest File
#
# Absolute Path Info
make_digest() {

    if [ "$#" -ne 2 ]; then
        exit
    fi

    # Find keyword 'vulnerability', 'sim_ticks', and 'sim_insts'.
    # Then, print whole line.
    sed -n '/^.*\(vulnerability\|sim_ticks\|sim_insts\).*$/p' $1 > $2
}

# Argument Parsing
for arg in "$@"
do
    case $arg in 
        --help)
            usage
            ;;
        --gemv-home=*)
            GEMV_HOME="${arg#*=}"
            ;;
        --sim-list=*)
            SIM_LIST="${arg#*=}"
            ;;
        --config-dir=*)
            CONFIG_DIR="${arg#*=}"
            ;;
    esac
done

GEMV_HOME=/home/yonsei_dclab/yohan/GemV-2.0/gemV  # To be deleted
BENCHMARK_HOME=/home/yonsei_dclab/misra-c-vulnerability/susan_modified  # To be deleted
GEMV_BINARY="$GEMV_HOME/build/ARM/gem5.opt"
GEMV_SIMSCRIPT="$GEMV_HOME/configs/example/se.py"

# Config List
misrac_tf=("" "_misrac")
susan_option=("" "-e" "-c")
susan_option_desc=("smoothing" "edge" "corner")

# Benchmark Input
input_file_name="input_large"
input_file_extension=".pgm"

for file in "/home/yonsei_dclab/misra-c-vulnerability/config/config*.csv"
do
    confignum=$(echo $file | sed 's/^\([^\/]*\/\)*config\([0-9]\+\).csv$/\2/')
    config=$(read_csvconfig $file)

    for misrac in "${misrac_tf[@]}";
    do
        benchmark="$BENCHMARK_HOME/susan${misrac}_ARM"
        for (( i=0 ; i < 3 ; i++));
        do
            output_dir="$GEMV_HOME/output/susan${misrac}_${susan_option_desc[$i]}_ARM/benchinput_${input_file_name}/config$confignum"
            mkdir -p $output_dir
            benchmark_input="$BENCHMARK_HOME/$input_file_name$input_file_extension${susan_option[$i]}"
            $GEMV_BINARY -re -d $output_dir $GEMV_SIMSCRIPT $config --cmd=${benchmark} --options=${benchmark_input} --vul_params="$GEMV_HOME/params.in"
        done
    done
done
