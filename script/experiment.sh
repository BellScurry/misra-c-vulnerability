#!/bin/bash
# Script Usage
# - $1: gemV Home
# - $2: gemV Config Directory
# - $3: Bench Config Directory
# - $4: Output Home

# Functions in This Script
#
# * usage()
# * csv_to_gemv_option()
# * make_digest()
# * stat_to_csv()
# * concat_csv()

# --help
usage() {

    echo "Usage: experiment.sh [--help] <gemV home> <gemV config directory> <bench config directory> <output home>"
}

# Usage
# - $1: Config File. Must be .csv format, e.g. config1.csv
csv_to_gemv_option() {

    if [[ "$#" -ne 1 ]]; then
        >&2 echo "Wrong number of arguments passed to function csv_to_gemv_option()"
        return 1
    fi

    result=""
    while IFS= read -r line || [[ -n $line ]];
    do
        col1=$(echo $line | sed 's/\(.*\),.*/\1/')

        if [[ ! -z $(echo $line | awk '/[^,]*,\s*\S+.*/') ]]; then

            col2=$(echo $line | sed 's/^[^,]*,[[:space:]]*\(.*\)$/\1/')
            result="$result --$col1=$col2 "
        else
            result="$result --$col1 "
        fi
    done < $1

    echo $result
}

# Usage
# - $1: Statistics File
# - Can be applied to .csv file, plain text file, etc.
make_digest() {

    if [[ "$#" -ne 1 ]]; then
        >&2 echo "Wrong number of arguments passed to function make_digest()"
        return 1
    fi

    # Find keyword 'vulnerability', 'sim_ticks', and 'sim_insts'.
    # Then, print whole line.
    sed -n '/^.*\(vulnerability\|sim_ticks\|sim_insts\).*$/p' $1
}

# Usage
# - $1: Stat File
# - Read stat file, then echo in csv format.
stat_to_csv() {

    if [[ "$#" -ne 1 ]]; then
        >&2 echo "Wrong number of arguments passed to function stat_to_csv()"
        return 1
    fi

    sed $1 \
        -e '/^.*\(Begin\|End\).*$/d' \
        -e '/^[[:space:]]*$/d' \
        -e 's/#.*$//' \
        -e 's/[[:space:]]\+\([^[:space:]]\+\)/, \1/g'
}

# Usage
# - $1: 1st CSV File
# - $2: 2nd CSV File
# - Concatenate contents of two csv files, 
#   assuming the two files have same keys.

_concat_csv() {

    linenum=0

    while IFS= read -r line || [[ -n $line ]];
    do
        linenum=$((linenum + 1))
        
        # Skip key comparison, assuming the two files have exactly same keys.
        first_key_value=$(sed -n "${linenum}p" < $1)
        
        # Use pipe to get line# before pattern matching.
        # For example, with
        #    key=$(sed -n "s/^\([^,]*\),\+.*$/\1/${linenum}p" < $1)
        # GNU sed will give line# after pattern matching.
        second_value=$(sed -n "${linenum}p" < $2 | sed -e "s/[^,]*,\(.*\)/\1/")
        echo "${first_key_value}, ${second_value}"
    done < $1

}

concat_csv() {

    # Initialization
    print_diff=false
    func_arghit=0

    for arg in "$@"
    do
        case $arg in 
            --diff)
                print_diff=true
                ;;
            -*)
                ;;
            *)
                func_arghit=$((func_arghit+1))
                case $func_arghit in
                    1)
                        file1=$arg
                        ;;
                    2)
                        file2=$arg
                        ;;
                esac
                ;;
        esac
    done
 
    if [[ "$func_arghit" -ne 2 ]]; then
        >&2 echo "Wrong number of arguments passed to function concat_csv()"
        return 1
    fi

    _concat_csv $file1 $file2
}

# Argument Parsing
arghit=0    # Number of essential arguments

for arg in "$@"
do
    case $arg in 
        --help)
            usage
            exit
            ;;
        --*)
            ;;
        -*)
            ;;
        *)
            arghit=$((arghit+1))
            case $arghit in
                1)
                    GEMV_HOME=${arg}
                    ;;
                2)
                    GEMV_CONFIG_DIR=${arg}
                    ;;
                3)
                    BENCH_CONFIG_DIR=${arg}
                    ;;
                4)
                    OUTPUT_HOME=${arg}
                    ;;
                *)
                    ;;
            esac
            ;;
    esac
done

if [[ "$arghit" -ne 4 ]]; then
    >&2 echo "ERROR: Wrong number of arguments to the program"
    usage
    return 1
fi

# CONSTANTS
GEMV_BINARY="${GEMV_HOME}/build/ARM/gem5.opt"
GEMV_SIMSCRIPT="${GEMV_HOME}/configs/example/se.py"

# Start Experiment
gemv_config_count=$(ls ${GEMV_CONFIG_DIR}/config*.csv | wc -l)
bench_config_count=$(ls ${BENCH_CONFIG_DIR}/config*.csv | wc -l)

for file in $GEMV_CONFIG_DIR/config*.csv
do
    gemv_confignum=$(echo $file | sed 's/^\([^\/]*\/\)*config\([0-9]\+\).csv$/\2/')
    
    # Convert contents in csv-format gemV config file
    # to gemV command line option string
    gemv_config=$(csv_to_gemv_option $file)

    outpath1="$OUTPUT_HOME/gemv_config${gemv_confignum}"
    rm -rf $outpath1

    for benchfile in $BENCH_CONFIG_DIR/config*.csv
    do
        bench_confignum=$(echo $benchfile | sed 's/^\([^\/]*\/\)*config\([0-9]\+\).csv$/\2/')

        # Convert contents in csv-format bench config file
        # to gemV command line option string
        bench_config=$(csv_to_gemv_option $benchfile)

        outpath2="$outpath1/bench_config${bench_confignum}"
        gemv_option="-re --outdir=$outpath2"
        simscript_option="${gemv_config} ${bench_config}"

        # Do Simulation
        $GEMV_BINARY $gemv_option $GEMV_SIMSCRIPT $simscript_option
        
        # Concat with pair .csv file
        # - We will concat config 1&2, 3&4, 5&6, etc.
        # - If '2' replaced by N, it can be easily generalized.
        odd=$(( (bench_confignum - 1)/2 * 2 + 1))
        even=$(( odd + 1))
        oddfile="$outpath1/bench_config${odd}/stats.txt"
        evenfile="$outpath1/bench_config${even}/stats.txt"

        if [[ -e ${oddfile} && -e ${evenfile} ]]; then

            stat="$outpath1/stats${odd}and${even}.csv"
            digest="$outpath1/digest${odd}and${even}.csv"

            # Temporary Files
            tmp_stat_odd=$(mktemp)
            tmp_stat_even=$(mktemp)
            tmp_stat=$(mktemp)
            tmp_digest=$(mktemp)

            # Convert stat file to csv format
            stat_to_csv $oddfile > $tmp_stat_odd
            stat_to_csv $evenfile > $tmp_stat_even

            # Make contents of concatenated stat file
            concat_csv $tmp_stat_odd $tmp_stat_even > $tmp_stat

            # Prefix
            #
            # - We will save prefix of '$concated_file' and '$digest'
            #   in a temporary file.
            # - The temporary file will be concatenated 
            #   with the file 'stats*and*.csv'
            # - $tmp_prefix: Filename of the temporary file
            # - The temporary file must be deleted 
            #   at the end of workload.
            # 
            # What prefix will include:
            #
            # - gemV Configuration Info
            # - Benchmark Configuration Info
            # - CSV Header

            # Make prefix temporary file
            tmp_prefix=$(mktemp)

            # gemV Configuration Info
            echo "---------- Common gemV Configurations: A1~A${gemv_config_count} ----------" >> $tmp_prefix
            echo ", A${gemv_confignum}" >> $tmp_prefix
            sed '/^[^,]\+\(,[,[:space:]]*\)*$/d' $file >> $tmp_prefix

            # Benchmark Configuration Info
            #
            # - Concat two bench config files
            #   into one integrated bench config file, 
            #   and concat it with digest file.
            echo "---------- Benchmark Configurations: B1~B${bench_config_count} ----------" >> $tmp_prefix
            echo ", B${odd}, B${even}" >> $tmp_prefix
            concat_csv $BENCH_CONFIG_DIR/config${odd}.csv $BENCH_CONFIG_DIR/config${even}.csv >> $tmp_prefix

            # CSV Header
            # - Specifying experiment number
            expnum_odd=$(( bench_config_count * (gemv_confignum-1) + odd ))
            expnum_even=$(( expnum_odd + 1))
            echo "---------- Statistics for Experiment E1~E$((gemv_config_count * bench_config_count))----------" >> $tmp_prefix
            echo ", E${expnum_odd}, E${expnum_even}, diff(E${expnum_odd} -> E${expnum_even})" >> $tmp_prefix

            # Specifying what gemV config & bench config used
            echo "Config, A${gemv_confignum} / B${odd}, A${gemv_confignum} / B${even}, " >> $tmp_prefix

            # Make contents of digest file 
            make_digest $tmp_stat > $tmp_digest

            # TODO:Caculate Ratio: (even/odd - 1) * 100 (%)

            # Concat prefix with statfile or digest file
            cat $tmp_prefix $tmp_stat > $stat
            cat $tmp_prefix $tmp_digest > $digest

            # Removal of the temporary files.
            rm $tmp_prefix $tmp_stat_odd $tmp_stat_even $tmp_stat $tmp_digest
        fi
    done
done
